@inject IMenuItemService MenuItemService;
@implements IDisposable;
@inject NavigationManager MyNavigationManager

<MudStack Spacing="4">
    <MudStack Row="true">
        <MudTextField @bind-Value="@_normalText" Label="Search" Margin="Margin.Dense" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"/>
        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" aria-label="github" Href="@_hrefUrl"></MudIconButton>
    </MudStack>
    <MudDivider/>
    <MudNavMenu Style="overflow: auto; height: 72vh" Bordered="true">
        @if (_loading)
        {
            <MudSkeleton Animation="Animation.Wave"/>
            <MudSkeleton Animation="Animation.Wave"/>
            <MudSkeleton Animation="Animation.Wave"/>
        }
        else
        {
            @foreach (var menuItem in MenuItems)
            {
                <MudNavLink Disabled="@menuItem.Disabled" Href="@menuItem.Route"
                            Icon="@menuItem.Icon">
                    @menuItem.Title
                </MudNavLink>
            }
        }
    </MudNavMenu>
</MudStack>


@code {

    string _normalText = "";

    bool _loading = false;
    string _hrefUrl = "";

    List<MenuItem> MenuItems { get; set; } = new();
    [Parameter] public required IFetchMenuItemService Service { get; set; }

    protected override void OnInitialized()
    {
        _hrefUrl = new Uri(MyNavigationManager.Uri).AbsolutePath;
        MenuItemService.Changed += OnChanged;
    }

    private void OnChanged(MenuItemEvent menuItemEvent, MenuItem menuItem)
    {
        switch (menuItemEvent)
        {
            case MenuItemEvent.Add:
                MenuItems.Add(menuItem);
                break;
            case MenuItemEvent.Update:
                var existingItem = MenuItems.Single(mi => mi.Id == menuItem.Id);
                existingItem = menuItem;
                break;
            case MenuItemEvent.Delete:
                MenuItems.Remove(menuItem);
                break;
            default:
                throw new NullReferenceException();
        }

        StateHasChanged();
    }

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        MenuItems = await Service.Fetch();
        _loading = false;
    }

    public void Dispose()
    {
        MenuItemService.Changed -= OnChanged;
    }

}